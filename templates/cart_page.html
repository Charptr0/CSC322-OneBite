{% extends 'base.html' %}

{% block links %}
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/cart_page.css') }}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nunito+Sans">
{% endblock links %}

{% block titlePage %} Cart {% endblock %}

{% block mainContent %}
<div class = "cover">
    <h2 class = "title">Cart</h2>
</div>

<div class = "split-vertical">
    <div id = "split-left">
        <div class = "summary-container" id = "cart-summary">
            <div class = "header-cart">
                <h1 class = "summary-title" style = "margin-bottom: 3px;">Cart Summary</h1>
            </div>

            <div id = "summary-cart">
                <div class = "cart-header">
                    <div class = "header-product" style = "text-align: left;">Product</div>
                    <div class = "header-name"></div>
                    <div class = "header-price" >Price</div>
                    <!-- <div class = "header-quantity" >Quantity</div> -->
                    <div class = "header-total" >Total</div>
                </div><hr>

                <div class = "product-summary">
                    {% for dish in order %}
                        <div class = "product">
                            <div class = "product-image"><img class = "cart-image" src = {{dish.img}}></div>
                            <div class = "product-name" style = "text-align: left; font-size: 20px;">{{dish.name}}</div>
                            <div class = "product-price">{{dish.price}}</div>
                            <!-- <div class = "product-quantity">
                                <button id = "minus-btn" value = "-" class = "plusminus-btn">-</button>
                                <input type = "number" id = "quantity" value = "1" class = "input-qty" autocomplete = "off" min = "1">
                                <button id = "plus-btn" value = "+" class = "plusminus-btn">+</button>
                            </div> -->
                            <div class = "product-total">
                                <div class = "product-line-price">12.99</div>
                                <div class = "product-removal" style = "padding-top: 140px;">
                                    <form method="post" action="/remove-dish-from-cart/{{dish.id}}">
                                        <button id = "remove-product" class = "remove-btn remove-product" type="submit">Remove</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div id = "split-right">
        <div class = "summary-container" id = "order-summary" style = "margin-bottom: 0px;">
            <h1 class = "summary-title">Order Summary</h1>
            <hr>
            <div class = "summary-info" id = "subtotal">
                <p class = "align-left">Subtotal:</p>
                <p class = "align-right">${{subtotal}}</p>
            </div>
            <div class = "summary-info" id = "sales-tax">
                <p class = "align-left">Estimated Tax:</p>
                <p class = "align-right">${{tax}}</p>
            </div>
            {% if user.isVIP == 1 %}
                <div class = "summary-info" id = "vip-discount">
                    <p class = "align-left">Discount:</p>
                    <p class = "align-right">${{discount}}</p>
                </div>      
            {% endif %}
            <hr>
            <div class = "summary-info" id = "total">
                <p class = "align-left" style = "font-size: 20px;">Total:</p>
                <p class = "align-right" stlye = "font-size: 20px;">${{total}}</p>
            </div>
            <form id = "proceed-form" method = "POST" action = "">
                <input type = "submit" id = "proceed-button" value = "Proceed to Checkout">
            </form>
        </div>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script>
    /* assign actions */
    $('.product-removal button').click(function() {removeItem(this);});
    $('.cart-removal button').click(function() {
        fadeTime = 450;
        removeItem($('.product-removal button'))
    });

    /* remove item from cart and recalculate summary */
    function removeItem(removeButton) {
        /* remove row */
        var productRow = $(removeButton).parent().parent().parent()
        productRow.slideUp(fadeTime, 
            function() {
                productRow.remove();
                recalculateCart();
            }
        )
    }

    var taxRate = 0.08875;
    var deliveryFee = 5.00;
    var fadeTime = 300;

    /* recalculate cart */
    function recalculateCart() {
        var subtotal = 0;

        /* sum up row totals */
        $('.product').each(
            function() {
                subtotal += parseFloat($(this).children('.product-line-price').text());
            }
        )

        /* calculate totals */
        var tax = subtotal * taxRate;
        var delivery = (subtotal > 0 ? deliveryFee : 0);
        var total = subtotal + tax + shipping;

        /* update totals display */
        $('.totals-value').fadeOut(fadeTime, 
            function() {
                $('#cart-subtotal').html(subtotal.toFixed(2));
                $('#cart-tax').html(tax.toFixed(2));
                $('#cart-delivery').html(delivery.toFixed(2));
                $('#cart-total').html(total.toFixed(2));
                if(total == 0){
                    $('.checkout').fadeOut(fadeTime);
                } else {
                    $('.checkout').fadeIn(fadeTime);
                }
                $('.totals-value').fadeIn(fadeTime);
            }
        );
    }

    /* update quantity */
    function updateQuantity(quantityInput) {
        /* calculate line price */
        var productRow = $(quantityInput).parent().parent();
        var price = parseFloat(productRow.children('.product-price').text());
        var quantity = $(quantityInput).val();
        var linePrice = price * quantity;

        /* update line price display and recalculate totals */
        productRow.children('.product-line-price').each(
            function() {
                $(this).fadeOut(fadeTime, 
                    function() {
                        $(this).text(linePrice.toFixed(2));
                        recalculateCart();
                        $(this).fadeIn(fadeTime);
                    }
                );
            }
        );
    }
</script>
{% endblock %}